#!/bin/bash
# Config: Calculated
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
	DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
	SOURCE="$(readlink "$SOURCE")"
	[[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_PATH="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

(cd $SCRIPT_PATH/../.. && mets-deploy vms.codeforeauclaire.org mets.zinid.com)

# Mets doesn't like Fibers 1.0.8 which Meteor seems to run on now
# * Git commit @ https://github.com/meteor/meteor/commit/c23a001d98875eb152cee6b5830066011b7380ad
# * Perhaps an issue because we manually use fibers?
# * Will get server logs errors, but not going to worry about it for now
# * Issue opened @ https://github.com/meteor/meteor/issues/6720
echo "Manually installing fibers 1.0.7 & restarting pm2 process (comments in this script)"
ssh root@mets.zinid.com "(cd /root/Meteors/vms.codeforeauclaire.org/bundle/programs/server && npm remove fibers && npm install fibers@1.0.7 --save && pm2 restart vms.codeforeauclaire.org)"
